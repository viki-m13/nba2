<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Q3 Over/Under Signal Engine</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Top Navigation Bar -->
  <header id="topbar">
    <div class="topbar-left">
      <div class="logo">
        <span class="logo-icon">&#9651;</span>
        <span class="logo-text">Q3 O/U ENGINE</span>
        <span class="logo-badge">LIVE</span>
      </div>
    </div>
    <nav class="topbar-nav">
      <a href="#dashboard" class="nav-link active" data-view="dashboard">Dashboard</a>
      <a href="#live" class="nav-link" data-view="live">Live Games</a>
      <a href="#alerts" class="nav-link" data-view="alerts">
        Alerts
        <span id="alert-count-badge" class="nav-badge hidden">0</span>
      </a>
      <a href="#history" class="nav-link" data-view="history">Historical</a>
      <a href="#backtest" class="nav-link" data-view="backtest">Backtest</a>
    </nav>
    <div class="topbar-right">
      <div class="refresh-indicator" id="refresh-indicator">
        <span class="refresh-dot"></span>
        <span class="refresh-text">Live</span>
      </div>
      <button class="settings-btn" id="settings-btn" title="Settings">&#9881;</button>
    </div>
  </header>

  <!-- Stats Bar -->
  <div id="stats-bar">
    <div class="stat-item">
      <span class="stat-value" id="stat-live-games">0</span>
      <span class="stat-label">Live Games</span>
    </div>
    <div class="stat-item">
      <span class="stat-value" id="stat-active-signals">0</span>
      <span class="stat-label">Active Signals</span>
    </div>
    <div class="stat-item ou-stat-item">
      <span class="stat-value highlight-gold" id="stat-ou-platinum">99.0%</span>
      <span class="stat-label">PLATINUM Acc</span>
    </div>
    <div class="stat-item ou-stat-item">
      <span class="stat-value highlight-gold" id="stat-ou-gold">96.9%</span>
      <span class="stat-label">GOLD Acc</span>
    </div>
    <div class="stat-item">
      <span class="stat-value highlight-green" id="stat-total-signals">1,060</span>
      <span class="stat-label">Historical Signals</span>
    </div>
    <div class="stat-item">
      <span class="stat-value highlight-green" id="stat-total-games">2,177</span>
      <span class="stat-label">Games Analyzed</span>
    </div>
    <div class="stat-item">
      <span class="stat-value" id="stat-next-refresh">5s</span>
      <span class="stat-label">Next Refresh</span>
    </div>
  </div>

  <!-- Main Content Area -->
  <main id="main-content">
    <!-- ==================== DASHBOARD VIEW ==================== -->
    <section id="view-dashboard" class="view active">
      <!-- Alert Banner -->
      <div id="signal-alert-banner" class="alert-banner hidden">
        <div class="alert-banner-icon">&#9888;</div>
        <div class="alert-banner-text">
          <strong>NEW SIGNAL:</strong>
          <span id="alert-banner-msg"></span>
        </div>
        <button class="alert-banner-close" id="alert-banner-close">&times;</button>
      </div>

      <!-- Q3 O/U Signals (primary focus) -->
      <div class="ou-signals-section">
        <div class="section-header">
          <h2>Q3 Over/Under Signals</h2>
          <span class="section-badge ou-badge" id="ou-signals-count">0</span>
        </div>
        <div class="ou-validation-strip">
          <div class="ou-val-item">
            <span class="ou-val-label">PLATINUM (&ge;20)</span>
            <span class="ou-val-value ou-platinum">99.0%</span>
          </div>
          <div class="ou-val-item">
            <span class="ou-val-label">GOLD (&ge;15)</span>
            <span class="ou-val-value ou-gold">96.9%</span>
          </div>
          <div class="ou-val-item">
            <span class="ou-val-label">SILVER (&ge;12)</span>
            <span class="ou-val-value ou-silver">93.4%</span>
          </div>
          <div class="ou-val-item">
            <span class="ou-val-label">BRONZE (&ge;10)</span>
            <span class="ou-val-value ou-bronze">90.9%</span>
          </div>
        </div>
        <div id="ou-signals-list" class="ou-signals-list">
          <div class="empty-state">
            <div class="empty-icon">&#9878;</div>
            <p>No O/U signals yet</p>
            <p class="empty-sub">Signals fire at Q3 end when model predicts final total with high margin from pregame O/U line (ESPN). Waiting for Q3 games.</p>
          </div>
        </div>
      </div>

      <div class="dashboard-grid">
        <!-- Live Games Column -->
        <div class="dashboard-col">
          <div class="section-header">
            <h2>Live Games</h2>
            <span class="section-badge" id="live-games-count">0</span>
          </div>
          <div id="dashboard-live-games" class="game-cards-list">
            <div class="empty-state">
              <div class="empty-icon">&#127936;</div>
              <p>No live games right now</p>
              <p class="empty-sub">Games will appear here when they start. Checking every 5 seconds.</p>
            </div>
          </div>
        </div>

        <!-- Score Flow Chart Column -->
        <div class="dashboard-col">
          <div class="section-header">
            <h2>Score Flow</h2>
            <div class="chart-controls">
              <select id="chart-game-select" class="select-input">
                <option value="">Select a game...</option>
              </select>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="scoreflow-chart"></canvas>
            <div id="chart-empty-state" class="chart-empty">
              <p>Select a live game to see score flow</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Upcoming Games -->
      <div class="upcoming-section">
        <div class="section-header">
          <h2>Upcoming Games</h2>
        </div>
        <div id="upcoming-games" class="upcoming-games-grid">
          <div class="empty-state">
            <div class="empty-icon">&#128197;</div>
            <p>Loading schedule...</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ==================== LIVE GAMES VIEW ==================== -->
    <section id="view-live" class="view">
      <div class="section-header">
        <h2>Live Games</h2>
        <div class="view-controls">
          <button class="btn btn-sm" id="refresh-now-btn">Refresh Now</button>
        </div>
      </div>
      <div id="live-games-full" class="game-cards-grid">
        <div class="empty-state">
          <div class="empty-icon">&#127936;</div>
          <p>No live games right now</p>
        </div>
      </div>

      <!-- Game Detail Panel -->
      <div id="game-detail-panel" class="game-detail hidden">
        <div class="section-header">
          <h2 id="detail-game-title">Game Detail</h2>
          <button class="btn btn-sm" id="close-detail-btn">Close</button>
        </div>
        <div class="detail-grid">
          <div class="detail-chart">
            <canvas id="detail-scoreflow-chart"></canvas>
          </div>
          <div class="detail-info">
            <div id="detail-signals-list"></div>
            <div id="detail-analytics"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ==================== ALERTS VIEW ==================== -->
    <section id="view-alerts" class="view">
      <div class="section-header">
        <h2>Q3 O/U Alerts</h2>
        <div class="view-controls">
          <button class="btn btn-sm btn-outline" id="clear-alerts-btn">Clear All</button>
          <div class="alert-stats">
            <span class="alert-stat-item">
              <span class="dot green"></span>
              Wins: <strong id="alert-wins">0</strong>
            </span>
            <span class="alert-stat-item">
              <span class="dot red"></span>
              Losses: <strong id="alert-losses">0</strong>
            </span>
            <span class="alert-stat-item">
              WR: <strong id="alert-wr" class="highlight-green">--</strong>
            </span>
          </div>
        </div>
      </div>
      <div id="alerts-list" class="alerts-list">
        <div class="empty-state">
          <div class="empty-icon">&#128276;</div>
          <p>No alerts yet</p>
          <p class="empty-sub">Alerts appear when Q3 O/U signals fire during live games.</p>
        </div>
      </div>
    </section>

    <!-- ==================== HISTORICAL VIEW ==================== -->
    <section id="view-history" class="view">
      <div class="section-header">
        <h2>Historical Q3 O/U Signals</h2>
        <div class="view-controls">
          <select id="history-filter" class="select-input">
            <option value="all">All Signals</option>
            <option value="PLATINUM">PLATINUM Only</option>
            <option value="GOLD">GOLD Only</option>
            <option value="SILVER">SILVER Only</option>
            <option value="BRONZE">BRONZE Only</option>
            <option value="OVER">OVER Only</option>
            <option value="UNDER">UNDER Only</option>
            <option value="correct">Correct Only</option>
            <option value="incorrect">Incorrect Only</option>
          </select>
          <select id="history-season-filter" class="select-input">
            <option value="all">All Seasons</option>
            <option value="2021-22">2021-22</option>
            <option value="2022-23">2022-23</option>
          </select>
        </div>
      </div>

      <!-- Historical Stats Summary -->
      <div class="history-stats-grid">
        <div class="history-stat-card">
          <div class="history-stat-value" id="hist-total-signals">1,060</div>
          <div class="history-stat-label">Total Signals</div>
        </div>
        <div class="history-stat-card">
          <div class="history-stat-value highlight-green" id="hist-accuracy">95.9%</div>
          <div class="history-stat-label">Overall Accuracy</div>
        </div>
        <div class="history-stat-card">
          <div class="history-stat-value highlight-green" id="hist-total-pnl">+886.6u</div>
          <div class="history-stat-label">Total P&L (flat bet)</div>
        </div>
        <div class="history-stat-card">
          <div class="history-stat-value highlight-green" id="hist-roi">+83.6%</div>
          <div class="history-stat-label">ROI</div>
        </div>
      </div>

      <!-- Equity Curve -->
      <div class="chart-section">
        <div class="section-header">
          <h2>Equity Curve (Cumulative P&L)</h2>
        </div>
        <div class="chart-container chart-container-lg">
          <canvas id="equity-chart"></canvas>
        </div>
      </div>

      <!-- Historical Signals Table -->
      <div class="history-table-section">
        <div class="section-header">
          <h2>Signal Log</h2>
          <span class="section-badge" id="hist-showing-count">0</span>
        </div>
        <div class="table-wrapper">
          <table id="history-table" class="data-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Game</th>
                <th>Direction</th>
                <th>Tier</th>
                <th>O/U Line</th>
                <th>Q3 Total</th>
                <th>Pred Final</th>
                <th>Actual Final</th>
                <th>Margin</th>
                <th>Result</th>
                <th>P&L</th>
              </tr>
            </thead>
            <tbody id="history-table-body">
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ==================== BACKTEST VIEW ==================== -->
    <section id="view-backtest" class="view">
      <div class="section-header">
        <h2>Q3 O/U Backtest Results</h2>
        <p class="section-subtitle">Linear regression model | 9 features | ESPN pregame O/U lines | 2,177 regulation games | Walk-forward validated</p>
      </div>

      <!-- Q3 O/U Tier Performance Cards -->
      <div class="ou-tier-cards-grid" id="ou-tier-cards-grid">
        <div class="ou-tier-card ou-tier-platinum">
          <div class="ou-tier-header">PLATINUM</div>
          <div class="ou-tier-accuracy" id="bt-platinum-acc">99.0%</div>
          <div class="ou-tier-label">Accuracy</div>
          <div class="ou-tier-stats">
            <div class="ou-tier-stat"><span>Margin:</span> <strong>&ge;20 pts</strong></div>
            <div class="ou-tier-stat"><span>Signals:</span> <strong id="bt-platinum-n">382</strong></div>
            <div class="ou-tier-stat"><span>W-L:</span> <strong id="bt-platinum-wl">378-4</strong></div>
            <div class="ou-tier-stat"><span>ROI:</span> <strong class="highlight-gold" id="bt-platinum-roi">+88.9%</strong></div>
            <div class="ou-tier-stat"><span>P&L:</span> <strong class="highlight-gold" id="bt-platinum-pnl">+339.6u</strong></div>
            <div class="ou-tier-stat"><span>Edge/bet:</span> <strong class="highlight-gold">+$0.89</strong></div>
          </div>
        </div>
        <div class="ou-tier-card ou-tier-gold">
          <div class="ou-tier-header">GOLD</div>
          <div class="ou-tier-accuracy" id="bt-gold-acc">96.9%</div>
          <div class="ou-tier-label">Accuracy</div>
          <div class="ou-tier-stats">
            <div class="ou-tier-stat"><span>Margin:</span> <strong>&ge;15 pts</strong></div>
            <div class="ou-tier-stat"><span>Signals:</span> <strong id="bt-gold-n">290</strong></div>
            <div class="ou-tier-stat"><span>W-L:</span> <strong id="bt-gold-wl">281-8</strong></div>
            <div class="ou-tier-stat"><span>ROI:</span> <strong class="highlight-gold" id="bt-gold-roi">+85.3%</strong></div>
            <div class="ou-tier-stat"><span>P&L:</span> <strong class="highlight-gold" id="bt-gold-pnl">+247.5u</strong></div>
            <div class="ou-tier-stat"><span>Edge/bet:</span> <strong class="highlight-gold">+$0.85</strong></div>
          </div>
        </div>
        <div class="ou-tier-card ou-tier-silver">
          <div class="ou-tier-header">SILVER</div>
          <div class="ou-tier-accuracy" id="bt-silver-acc">93.4%</div>
          <div class="ou-tier-label">Accuracy</div>
          <div class="ou-tier-stats">
            <div class="ou-tier-stat"><span>Margin:</span> <strong>&ge;12 pts</strong></div>
            <div class="ou-tier-stat"><span>Signals:</span> <strong id="bt-silver-n">212</strong></div>
            <div class="ou-tier-stat"><span>W-L:</span> <strong id="bt-silver-wl">198-12</strong></div>
            <div class="ou-tier-stat"><span>ROI:</span> <strong class="highlight-green" id="bt-silver-roi">+79.2%</strong></div>
            <div class="ou-tier-stat"><span>P&L:</span> <strong class="highlight-green" id="bt-silver-pnl">+168.0u</strong></div>
            <div class="ou-tier-stat"><span>Edge/bet:</span> <strong class="highlight-green">+$0.79</strong></div>
          </div>
        </div>
        <div class="ou-tier-card ou-tier-bronze">
          <div class="ou-tier-header">BRONZE</div>
          <div class="ou-tier-accuracy" id="bt-bronze-acc">90.9%</div>
          <div class="ou-tier-label">Accuracy</div>
          <div class="ou-tier-stats">
            <div class="ou-tier-stat"><span>Margin:</span> <strong>&ge;10 pts</strong></div>
            <div class="ou-tier-stat"><span>Signals:</span> <strong id="bt-bronze-n">176</strong></div>
            <div class="ou-tier-stat"><span>W-L:</span> <strong id="bt-bronze-wl">160-14</strong></div>
            <div class="ou-tier-stat"><span>ROI:</span> <strong class="highlight-green" id="bt-bronze-roi">+74.7%</strong></div>
            <div class="ou-tier-stat"><span>P&L:</span> <strong class="highlight-green" id="bt-bronze-pnl">+131.5u</strong></div>
            <div class="ou-tier-stat"><span>Edge/bet:</span> <strong class="highlight-green">+$0.75</strong></div>
          </div>
        </div>
      </div>

      <!-- Season Breakdown -->
      <div class="backtest-table-section">
        <div class="section-header">
          <h2>Season Breakdown</h2>
        </div>
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Season</th>
                <th>Tier</th>
                <th>Signals</th>
                <th>Correct</th>
                <th>Accuracy</th>
                <th>P&L (units)</th>
                <th>ROI</th>
              </tr>
            </thead>
            <tbody id="backtest-breakdown-body">
            </tbody>
          </table>
        </div>
      </div>

      <!-- Methodology -->
      <div class="ou-methodology-card">
        <h3>Methodology</h3>
        <div class="ou-method-grid">
          <div class="ou-method-item">
            <strong>Model:</strong> Linear regression predicting Q4 total scoring from 9 features available at Q3 end.
          </div>
          <div class="ou-method-item">
            <strong>Core Insight:</strong> Q4 scoring averages ~54pts regardless of game state. When games deviate from the opening O/U pace, the line becomes mispriced.
          </div>
          <div class="ou-method-item">
            <strong>Features:</strong> avg_q_pace, q3_lead, q3_total, pace_trend, q3_cumul_total, h1_total, scoring_variance, late_q3_pts, pace_ratio.
          </div>
          <div class="ou-method-item">
            <strong>Data Source:</strong> ESPN pregame O/U lines (pickcenter consensus). No fallbacks or estimations.
          </div>
          <div class="ou-method-item">
            <strong>Validation:</strong> Walk-forward: trained on 2021-22 (1,162 games), tested OOS on 2022-23 (1,015 games). Both seasons validate independently.
          </div>
          <div class="ou-method-item">
            <strong>Risk:</strong> Standard -110 juice. Break-even at 52.4%. Quarter-Kelly sizing recommended. Max 15% of bankroll per signal.
          </div>
        </div>
      </div>

      <!-- Disclaimer -->
      <div class="disclaimer">
        <strong>Disclaimer:</strong> Past performance does not guarantee future results.
        Validated on 2,177 real ESPN games (2021-22 &amp; 2022-23 NBA seasons, regulation only).
        O/U lines sourced from ESPN pickcenter (consensus). No fallbacks, no estimated lines, no assumptions.
        Results assume -110 standard vig. Always bet responsibly.
      </div>
    </section>
  </main>

  <!-- Settings Modal -->
  <div id="settings-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>Settings</h2>
        <button class="modal-close" id="settings-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="setting-group">
          <label>CORS Proxy (for live data)</label>
          <input type="text" id="cors-proxy-input" class="text-input"
                 placeholder="https://corsproxy.io/?" value="">
          <p class="setting-help">Required for live data on GitHub Pages. Leave empty for Vercel deployment.</p>
        </div>
        <div class="setting-group">
          <label>Refresh Interval (seconds)</label>
          <input type="number" id="refresh-interval-input" class="text-input"
                 value="5" min="3" max="60">
        </div>
        <div class="setting-group">
          <label>
            <input type="checkbox" id="sound-enabled" checked>
            Sound Alerts
          </label>
        </div>
        <div class="setting-group">
          <label>
            <input type="checkbox" id="notification-enabled">
            Browser Notifications
          </label>
        </div>
        <div class="setting-group">
          <label>Minimum Signal Tier</label>
          <select id="min-tier-select" class="select-input">
            <option value="BRONZE">All Tiers (BRONZE+)</option>
            <option value="SILVER">SILVER+</option>
            <option value="GOLD">GOLD+</option>
            <option value="PLATINUM">PLATINUM Only</option>
          </select>
        </div>
        <button class="btn btn-primary" id="save-settings-btn">Save Settings</button>
      </div>
    </div>
  </div>

  <!-- Audio for alerts -->
  <audio id="alert-sound" preload="auto"></audio>

  <!-- Scripts -->
  <script src="js/q3-ou-engine.js"></script>
  <script src="js/historical-data.js"></script>
  <script src="js/nba-api.js"></script>
  <script src="js/charts.js"></script>
  <script src="js/main.js"></script>
</body>
</html>
